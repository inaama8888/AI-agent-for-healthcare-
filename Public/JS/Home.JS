const chatBox = document.getElementById("chat-box");
const input = document.getElementById("user-input");
const sendBtn = document.getElementById("send-btn");

let step = "greet";
let userName = "";
let lessons = [];

window.onload = () => {
  addBotMessage("×©×œ×•× ×•×‘×¨×•×š ×”×‘× ×œ×¡×•×›×Ÿ ×œ×‘×¨×™××•×ª, ×ª××™×›×” ×•×—×•×¡×Ÿ! ××” ×”×©× ×©×œ×š?");
};

sendBtn.addEventListener("click", sendMessage);
input.addEventListener("keypress", (e) => {
  if (e.key === "Enter") sendMessage();
});

function sendMessage() {
  const text = input.value.trim();
  if (!text) return;

  addUserMessage(text);
  input.value = "";

  if (step === "greet") {
    userName = text;
    addBotMessage(`× ×¢×™× ×××•×“ ${userName}!`);
    setTimeout(() => showMainMenu(), 600);
    step = "menu";
  } else if (step === "menu") {
    handleMenuChoice(text);
  } else if (step === "register") {
    handleLessonSelection(text);
  }
}

function addBotMessage(text) {
  const msg = document.createElement("div");
  msg.classList.add("bot-message");
  msg.textContent = text;
  chatBox.appendChild(msg);
  chatBox.scrollTop = chatBox.scrollHeight;
}

function addUserMessage(text) {
  const msg = document.createElement("div");
  msg.classList.add("user-message");
  msg.textContent = text;
  chatBox.appendChild(msg);
  chatBox.scrollTop = chatBox.scrollHeight;
}

function showMainMenu() {
  addBotMessage("×‘×—×¨ ×¤×¢×•×œ×”:");
  addBotMessage("1ï¸âƒ£ ×”×¨×©××” ×œ×©×™×¢×•×¨");
  addBotMessage("2ï¸âƒ£ ×©××œ×•×ª ×•×ª×©×•×‘×•×ª ×¢×œ ×©×™×¢×•×¨×™×");
  addBotMessage("3ï¸âƒ£ ×”×“×¨×›×” ×¢× ×¡×•×›×Ÿ ×¨×’×©×™");
}

function handleMenuChoice(choice) {
  switch (choice) {
    case "1":
      addBotMessage(`×©××—×™× ×©×‘×—×¨×ª ×œ×”×™×¨×©× ×œ×©×™×¢×•×¨×™× ×©×œ× ×• ğŸŒ¿`);
      fetchLessons();
      break;
    case "2":
      addBotMessage(`×©××œ/×™ ×›×œ ×©××œ×” ×¢×œ ××¢×¨×›×™ ×”×©×™×¢×•×¨×™× ğŸ“˜`);
      break;
    case "3":
      addBotMessage(`× ×©××— ×œ×©×•×—×— ××™×ª×š ×¢×œ ×”×ª×—×•×©×•×ª ×©×œ×š ğŸ’¬`);
      break;
    default:
      addBotMessage("×× × ×”×–×Ÿ ××¡×¤×¨ ×‘×™×Ÿ 1 ×œ-3 ğŸ™");
  }
}

async function fetchLessons() {
  try {
    const res = await fetch("/api/lessons");
    const data = await res.json();
    lessons = data.lessons || [];
    if (lessons.length === 0) {
      addBotMessage("×œ× × ××¦××• ×©×™×¢×•×¨×™× ×–××™× ×™× ×›×¨×’×¢ ğŸ™");
      return;
    }
    addBotMessage("×”× ×” ×¨×©×™××ª ×”×©×™×¢×•×¨×™× ×”×§×¨×•×‘×™×:");
    lessons.forEach((lesson, i) => {
      addBotMessage(`${i + 1}. ${lesson.title} 
ğŸ“… ×ª××¨×™×š: ${lesson.date} â° ×©×¢×”: ${lesson.time}
ğŸ‘©â€ğŸ« ×× ×—×”: ${lesson.instructor} ğŸ“ ××§×•×: ${lesson.location}`);
    });
    addBotMessage("×× × ×”×§×œ×“ ××¡×¤×¨ ×‘×™×Ÿ 1 ×œ-5 ×›×“×™ ×œ×”×™×¨×©× ×œ×©×™×¢×•×¨ ×”×¨×¦×•×™");
    step = "register";
  } catch (err) {
    addBotMessage("×©×’×™××” ×‘×©×œ×™×¤×ª ×”×©×™×¢×•×¨×™× ××”×©×¨×ª âŒ");
  }
}

async function handleLessonSelection(choice) {
  const index = parseInt(choice) - 1;
  if (isNaN(index) || index < 0 || index >= lessons.length) {
    addBotMessage("×× × ×”×–×Ÿ ××¡×¤×¨ ×ª×§×™×Ÿ ×‘×™×Ÿ 1 ×œ-5 ğŸ™");
    return;
  }

  const chosenLesson = lessons[index];
  try {
    const res = await fetch("/api/register", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ name: userName, lesson_id: chosenLesson.lesson_id })
    });
    const result = await res.json();

    if (result.status === "OK") {
      addBotMessage(`× ×¨×©××ª ×‘×”×¦×œ×—×” ×œ×©×™×¢×•×¨ "${chosenLesson.title}" âœ…`);
    } else {
      addBotMessage(result.message || "×©×’×™××” ×‘×”×¨×©××” âŒ");
    }
  } catch (err) {
    addBotMessage("×©×’×™××” ×‘×—×™×‘×•×¨ ×œ×©×¨×ª âŒ");
  }

  addBotMessage("××” ×ª×¨×¦×”/×™ ×œ×¢×©×•×ª ×¢×›×©×™×•?");
  showMainMenu();
  step = "menu";
}
