const chatBox = document.getElementById("chat-box");
const input = document.getElementById("user-input");
const sendBtn = document.getElementById("send-btn");

let step = "greet";
let userName = "";
let lessons = [];

window.onload = () => {
  addBotMessage("×©×œ×•× ×•×‘×¨×•×š ×”×‘× ×œ×¡×•×›×Ÿ ×œ×‘×¨×™××•×ª, ×ª××™×›×” ×•×—×•×¡×Ÿ! ××” ×”×©× ×©×œ×š?");
};

sendBtn.addEventListener("click", sendMessage);
input.addEventListener("keypress", (e) => {
  if (e.key === "Enter") sendMessage();
});

function sendMessage() {
  const text = input.value.trim();
  if (!text) return;

  addUserMessage(text);
  input.value = "";

  if (step === "greet") {
    userName = text;
    addBotMessage(`× ×¢×™× ×××•×“ ${userName}!`);
    setTimeout(() => showMainMenu(), 500);
    step = "menu";
  }

  else if (step === "menu") {
    handleMenuChoice(text);
  }

  else if (step === "register") {
    handleLessonSelection(text);
  }
}

function addBotMessage(text) {
  const msg = document.createElement("div");
  msg.classList.add("bot-message");
  msg.textContent = text;
  chatBox.appendChild(msg);
  chatBox.scrollTop = chatBox.scrollHeight;
}

function addUserMessage(text) {
  const msg = document.createElement("div");
  msg.classList.add("user-message");
  msg.textContent = text;
  chatBox.appendChild(msg);
  chatBox.scrollTop = chatBox.scrollHeight;
}

function showMainMenu() {
  addBotMessage("×‘×—×¨ ×¤×¢×•×œ×”:");
  addBotMessage("1ï¸âƒ£ ×”×¨×©××” ×œ×©×™×¢×•×¨");
  addBotMessage("2ï¸âƒ£ ×©××œ×•×ª ×¢×œ ×©×™×¢×•×¨×™×");
  addBotMessage("3ï¸âƒ£ ×©×™×—×” ×¢× ×¡×•×›×Ÿ ×¨×’×©×™");
}

function handleMenuChoice(choice) {
  switch (choice) {
    case "1":
      addBotMessage("××¦×™×’ ×©×™×¢×•×¨×™×...");
      fetchLessons();
      break;

    case "2":
      addBotMessage("×©××œ ××•×ª×™ ×©××œ×” ×¢×œ ×©×™×¢×•×¨×™×.");
      break;

    case "3":
      addBotMessage("××™×š ××ª/×” ××¨×’×™×©/×” ×”×™×•×?");
      break;

    default:
      addBotMessage("×× × ×”×–×Ÿ ××¡×¤×¨ ×‘×™×Ÿ 1 ×œ-3 ğŸ™");
  }
}

async function fetchLessons() {
  try {
    const res = await fetch("/api/lessons");
    const data = await res.json();

    lessons = data.lessons;

    addBotMessage("ğŸ”¥ ×”× ×” ×”×©×™×¢×•×¨×™× ×”×–××™× ×™×:");

    lessons.forEach((lesson, index) => {
      const dateObj = new Date(lesson.date);
      const date = dateObj.toLocaleDateString("he-IL");
      const time = dateObj.toLocaleTimeString("he-IL", {hour: '2-digit', minute:'2-digit'});

      addBotMessage(
        `${index + 1}. ${lesson.title}
ğŸ“… ${date} â° ${time}
ğŸ‘©â€ğŸ« ×× ×—×”: ${lesson.instructor}`
      );
    });

    addBotMessage("×”×§×œ×“ ××¡×¤×¨ ×›×“×™ ×œ×‘×—×•×¨ ×©×™×¢×•×¨:");
    step = "register";

  } catch (err) {
    addBotMessage("âŒ ×©×’×™××” ×‘×©×œ×™×¤×ª ×”×©×™×¢×•×¨×™× ××”×©×¨×ª");
  }
}

async function handleLessonSelection(choice) {
  const index = parseInt(choice) - 1;

  if (isNaN(index) || index < 0 || index >= lessons.length) {
    addBotMessage("××¡×¤×¨ ×œ× ×ª×§×™×Ÿ, × ×¡×” ×©×•×‘ ğŸ™");
    return;
  }

  const selected = lessons[index];

  try {
    const res = await fetch("/api/register", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ name: userName, lesson_id: selected.lesson_id })
    });

    const result = await res.json();

    if (result.status === "OK") {
      addBotMessage(`ğŸ‰ × ×¨×©××ª ×‘×”×¦×œ×—×” ×œ×©×™×¢×•×¨ "${selected.title}"!`);
    } else {
      addBotMessage("âŒ ×©×’×™××” ×‘×”×¨×©××”");
    }
  } catch {
    addBotMessage("âŒ ×‘×¢×™×™×ª ×ª×§×©×•×¨×ª ×¢× ×”×©×¨×ª");
  }

  showMainMenu();
  step = "menu";
}
